<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Web Metric</title>
	<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
	<style>
		select {
			height: 22px;
			margin-left: 50px;
		}

		#see_paint,
		#see_paint_area {
			margin-left: 10px;
		}

		#content {
			margin-top: 10px;
		}
	</style>
</head>

<body>
	<div id="metadata">
		<input type="text" id="url">
		<input type="button" value="GOTO" onclick="submit()">
	</div>
	<div id="content">
		<div id="doc"></div>
		<div id="paint_area">
			<canvas id="paint"></canvas>
		</div>
	</div>
	<div id="error" style="position: absolute; left: 10px; bottom: 10px; color: crimson; font-size: 12px;"></div>
	<script>
		const { ipcRenderer } = require("electron");

		canvas = document.getElementById("paint");
		context = canvas.getContext("2d");
		context.lineWidth = 1;

		ipcRenderer.on("asynchronous-reply", (event, arg) => {
			switch (arg.name) {
				case "PASS-URL":
					if (arg.type && arg.type === "error") {
						document.getElementById("error").innerHTML = arg.value;
						document.getElementById("doc").innerText = "";
					}
					break;
				case "MAIN-DOC":
					document.getElementById("doc").innerText = arg.value;
					break;
				case "PAINT-REGION":
					canvas = document.getElementById("paint");
					canvas.width = arg.value.width + '';
					canvas.height = arg.value.height + '';
					canvas.style = "border: darkcyan 1px dashed; padding: 10px";
					break;
				case "PAINT-COUNT":
					if ((selectNode = document.getElementById("paint_index"))) {
						while (selectNode.length) {
							selectNode.remove(0);
						}
						if (arg.value) {
							for (var i = 0; i < arg.value; i++) {
								var option = document.createElement('option');
								option.text = i + 1;
								option.value = i + 1;
								selectNode.add(option);
							}
						}
					}
					else if (arg.value) {
						var metadata = document.getElementById("metadata");
						var selectNode = document.createElement("select");
						selectNode.id = "paint_index";
						for (var i = 0; i < arg.value; i++) {
							var option = document.createElement('option');
							option.text = i + 1;
							option.value = i + 1;
							selectNode.add(option);
						}
						metadata.appendChild(selectNode);

						var inputNode = document.createElement("input");
						inputNode.type = "button";
						inputNode.id = "see_paint";
						inputNode.value = "SEE PAINT";
						inputNode.onclick = seePaint;
						metadata.appendChild(inputNode);

						var inputNode_ = document.createElement("input");
						inputNode_.type = "button";
						inputNode_.id = "see_paint_area";
						inputNode_.value = "SEE PAINT AREA";
						inputNode_.onclick = seePaintArea;
						metadata.appendChild(inputNode_);
					}
					break;
				case "SEE-PAINT":
					// SKIA COLOR IS ARGB.
					command = arg.value;
					switch (command.method) {
						case "drawRect":
							context.fillStyle = '#' + command.params.paint.color.slice(3);
							context.fillRect(
								command.params.rect.left,
								command.params.rect.top,
								command.params.rect.right - command.params.rect.left,
								command.params.rect.bottom - command.params.rect.top
							);
							break;
						case "drawRRect":
							context.fillStyle = '#' + command.params.paint.color.slice(3);
							context.fillRect(
								command.params.rrect.left,
								command.params.rrect.top,
								command.params.rrect.right - command.params.rrect.left,
								command.params.rrect.bottom - command.params.rrect.top
							);
							break;
						case "drawImageRect":
							context.fillStyle = '#' + command.params.paint.color.slice(3);
							context.fillRect(
								command.params.dst.left,
								command.params.dst.top,
								command.params.dst.right - command.params.dst.left,
								command.params.dst.bottom - command.params.dst.top
							);
						case "drawTextBlob":
							context.fillStyle = '#' + command.params.paint.color.slice(3);
							context.fillText(arg.content, command.params.x, command.params.y);
							break;
						default:
							break;
					}
					break;
				case "SEE-PAINT-AREA":
					rect = arg.value;
					switch (rect.type) {
						case "rect":
							context.strokeStyle = "#FF0000";
							break;
						case "rrect":
							context.strokeStyle = "#00FF00";
							break;
						case "image":
							context.strokeStyle = "#0000FF";
							break;
						case "text":
							context.strokeStyle = "#00AAFF";
							break;
						default:
							break;
					}
					context.strokeRect(rect.left, rect.top, rect.right - rect.left, rect.bottom - rect.top);
					break;
				case "TEST":
					console.log(arg.value);
					break;
				default:
					break;
			}
		});

		function submit() {
			url = document.getElementById('url').value;
			ipcRenderer.send('asynchronous-message', { name: "PASS-URL", url: url });
		}

		function seePaint() {
			document.getElementById("error").innerHTML = "";
			context.clearRect(0, 0, canvas.width, canvas.height);
			paintIndex = parseInt(document.getElementById("paint_index").value);
			ipcRenderer.send('asynchronous-message', { name: "SEE-PAINT", index: paintIndex });
		}

		function seePaintArea() {
			document.getElementById("error").innerHTML = "";
			context.clearRect(0, 0, canvas.width, canvas.height);
			paintIndex = parseInt(document.getElementById("paint_index").value);
			ipcRenderer.send('asynchronous-message', { name: "SEE-PAINT-AREA", index: paintIndex });
		}

		function updateWindow() {
			// DOES NOT WORK! WHY?
			ipcRenderer.send('asynchronous-message', {
				name: "UPDATE-WINDOW",
				value: {
					width: Math.max(
						document.body.scrollWidth, document.documentElement.scrollWidth,
						document.body.offsetWidth, document.documentElement.offsetWidth,
						document.body.clientWidth, document.documentElement.clientWidth),
					height: Math.max(
						document.body.scrollHeight, document.documentElement.scrollHeight,
						document.body.offsetHeight, document.documentElement.offsetHeight,
						document.body.clientHeight, document.documentElement.clientHeight)
				}
			});
		}
	</script>
</body>

</html>