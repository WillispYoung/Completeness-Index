<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Web Metric</title>
	<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
	<style>
		div {
			margin: 5px;
		}

		select {
			height: 22px;
			margin-left: 50px;
			margin-right: 5px;
		}
	</style>
</head>

<body>
	<div id="metadata">
		<input type="text" id="url">
		<input type="button" value="GOTO" onclick="submit()">
	</div>
	<div id="content">
		<div id="doc"></div>
		<div id="paint_area">
			<canvas id="paint"></canvas>
		</div>
	</div>
	<div id="error" style="position: absolute; left: 10px; bottom: 10px; color: crimson;"></div>
	<!-- <script src=""></script> -->
	<script>
		const { ipcRenderer } = require("electron");

		canvas = document.getElementById("paint");
		context = canvas.getContext("2d");
		context.setLineDash([3, 1]);

		ipcRenderer.on("asynchronous-reply", (event, arg) => {
			switch (arg.name) {
				case "PASS-URL":
					if (arg.type && arg.type === "error") {
						document.getElementById("error").innerHTML = arg.value;
						document.getElementById("doc").innerText = "";
					}
					break;
				case "MAIN-DOC":
					document.getElementById("doc").innerText = arg.value;
					break;
				case "PAINT-REGION":
					canvas = document.getElementById("paint");
					canvas.width = arg.value.width + '';
					canvas.height = arg.value.height + '';
					canvas.style = "border: darkcyan 1px dashed;";
					break;
				case "PAINT-COUNT":
					if (arg.value) {
						var metadata = document.getElementById("metadata");

						var selectNode = document.createElement("select");
						selectNode.id = "paint_index";
						for (var i = 0; i < arg.value; i++) {
							var option = document.createElement('option');
							option.text = i + 1;
							option.value = i + 1;
							selectNode.add(option);
						}
						metadata.appendChild(selectNode);

						var inputNode = document.createElement("input");
						inputNode.type = "button";
						inputNode.value = "SEE PAINT";
						inputNode.onclick = seePaint;
						metadata.appendChild(inputNode);
					}
					break;
				case "SEE-PAINT":
					// SKIA COLOR IS ARGB.
					command = arg.value;
					switch (command.method) {
						case "drawRect":
							// context.strokeStyle = '#' + command.params.paint.color.slice(3);
							context.strokeStyle = "#FF0000";
							// context.fillRect(
							// 	command.params.rect.left + 1,
							// 	command.params.rect.top + 1,
							// 	command.params.rect.right - command.params.rect.left - 2,
							// 	command.params.rect.bottom - command.params.rect.top - 2
							// );
							context.strokeRect(
								command.params.rect.left,
								command.params.rect.top,
								command.params.rect.right - command.params.rect.left,
								command.params.rect.bottom - command.params.rect.top
							);
							break;
						case "drawRRect":
							// context.strokeStyle = '#' + command.params.paint.color.slice(3);
							context.strokeStyle = "#00FF00";
							// context.fillRect(
							// 	command.params.rrect.left + 1, 
							// 	command.params.rrect.top + 1,
							// 	command.params.rrect.right - command.params.rrect.left - 2,
							// 	command.params.rrect.bottom - command.params.rrect.top - 2
							// );
							context.strokeRect(
								command.params.rrect.left + 1,
								command.params.rrect.top + 1,
								command.params.rrect.right - command.params.rrect.left - 2,
								command.params.rrect.bottom - command.params.rrect.top - 2
							);
							break;
						case "drawImageRect":
							// context.strokeStyle = '#' + command.params.paint.color.slice(3);
							context.strokeStyle = "#0000FF";
							// context.fillRect(
							// 	command.params.dst.left,
							// 	command.params.dst.top,
							// 	command.params.dst.right - command.params.dst.left,
							// 	command.params.dst.bottom - command.params.dst.top
							// );
							context.strokeRect(
								command.params.dst.left,
								command.params.dst.top,
								command.params.dst.right - command.params.dst.left,
								command.params.dst.bottom - command.params.dst.top
							);
							break;
						case "drawTextBlob":
							// console.log(arg.content);
							context.fillStyle = '#' + command.params.paint.color.slice(3);
							context.fillText(arg.content, command.params.x, command.params.y);
							break;
						default:
							break;
					}
					break;
				default:
					break;
			}
		});

		function submit() {
			url = document.getElementById('url').value;
			ipcRenderer.send('asynchronous-message', { name: "PASS-URL", url: url });
		}

		function seePaint() {
			document.getElementById("error").innerHTML = "";
			context.clearRect(0, 0, canvas.width, canvas.height);
			paintIndex = parseInt(document.getElementById("paint_index").value);
			ipcRenderer.send('asynchronous-message', { name: "SEE-PAINT", index: paintIndex });
		}

		function updateWindow() {
			// DOES NOT WORK! WHY?
			ipcRenderer.send('asynchronous-message', {
				name: "UPDATE-WINDOW",
				value: {
					width: Math.max(
						document.body.scrollWidth, document.documentElement.scrollWidth,
						document.body.offsetWidth, document.documentElement.offsetWidth,
						document.body.clientWidth, document.documentElement.clientWidth),
					height: Math.max(
						document.body.scrollHeight, document.documentElement.scrollHeight,
						document.body.offsetHeight, document.documentElement.offsetHeight,
						document.body.clientHeight, document.documentElement.clientHeight)
				}
			});
		}
	</script>
</body>

</html>